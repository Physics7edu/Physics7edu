<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Vertical Block–Pulley–Person (Tension vs Weight)</title>

  <!-- GlowScript / VPython -->
  <script src="https://www.glowscript.org/lib/jquery/2.1/jquery.min.js"></script>
  <script src="https://www.glowscript.org/lib/jquery/2.1/jquery-ui.custom.min.js"></script>
  <script src="https://www.glowscript.org/package/glow.3.2.min.js"></script>
  <script src="https://www.glowscript.org/package/RSrun.3.2.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    html,body{height:100%;margin:0;background:#0f172a;color:#e5e7eb;font-family:Inter,system-ui,sans-serif}
    .wrap{display:flex;height:100vh}
    .left{width:22rem;padding:1rem;background:#111827;overflow:auto;border-right:1px solid #1f2937}
    .card{background:#1f2937;border-radius:.7rem;padding:.8rem;box-shadow:0 6px 14px rgba(0,0,0,.35);margin-bottom:.8rem}
    .label{font-weight:800;margin:.2rem 0 .4rem}
    .row{display:flex;gap:.6rem;align-items:center}
    .row>*{flex:1}
    input[type=number]{color:#111827;padding:.35rem;border-radius:.4rem}
    .btn{background:#2563eb;color:#fff;border:none;border-radius:.45rem;font-weight:800;padding:.5rem 0}
    .btn:hover{background:#1d4ed8}
    .pair{display:flex;justify-content:space-between;font-weight:800;margin:.18rem 0}
    .pair span:last-child{color:#facc15}
    .right{flex:1;display:flex}
    #glowscript{flex:1}
  </style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <h1 class="text-lg font-extrabold mb-2">Vertical Block–Pulley–Person (Frictionless)</h1>

    <div class="card">
      <div class="label">Mass of block m (kg)</div>
      <div class="row">
        <input id="mSlider" type="range" min="0.5" max="50" step="0.5" value="10">
        <input id="mInput"  type="number" min="0.5" max="50" step="0.5" value="10">
      </div>

      <div class="label">Tension T (N)</div>
      <div class="row">
        <input id="TSlider" type="range" min="0" max="600" step="5" value="120">
        <input id="TInput"  type="number" min="0" max="600" step="5" value="120">
      </div>

      <div class="label">Gravity g (m/s²)</div>
      <div class="row">
        <input id="gSlider" type="range" min="0" max="20" step="0.1" value="9.8">
        <input id="gInput"  type="number" min="0" max="20" step="0.1" value="9.8">
      </div>

      <div class="row" style="gap:.5rem;margin-top:.5rem">
        <button id="btnPlay"  class="btn">Play</button>
        <button id="btnPause" class="btn">Pause</button>
        <button id="btnReset" class="btn">Reset</button>
      </div>
      <p id="bootWarn" class="text-sm text-red-300 mt-2" style="display:none">
        Loading 3D engine… If this persists, a network/content blocker may be preventing glowscript.org from loading.
      </p>
    </div>

    <div class="card">
      <div class="pair"><span>Acceleration a</span><span id="aLbl">—</span></div>
      <div class="pair"><span>Velocity v</span><span id="vLbl">—</span></div>
      <div class="pair"><span>Displacement y</span><span id="yLbl">—</span></div>
      <div class="pair"><span>Time t</span><span id="tLbl">—</span></div>
      <p class="text-xs text-gray-300 mt-2">
        Model: ideal rope & pulley, no friction or pulley inertia. Upward is +y. \(a = T/m - g\).
      </p>
    </div>
  </div>

  <div class="right">
    <div id="glowscript"></div>
  </div>
</div>

<script>
(function(){
  // ====== DOM ======
  const $ = id => document.getElementById(id);
  const mS=$('mSlider'), mI=$('mInput');
  const TS=$('TSlider'), TI=$('TInput');
  const gS=$('gSlider'), gI=$('gInput');
  const btnPlay=$('btnPlay'), btnPause=$('btnPause'), btnReset=$('btnReset');
  const aLbl=$('aLbl'), vLbl=$('vLbl'), yLbl=$('yLbl'), tLbl=$('tLbl'), bootWarn=$('bootWarn');

  // ====== State ======
  let m=10;       // kg
  let T=120;      // N
  let g=9.8;      // m/s^2 (down)
  let y=0, v=0;   // displacement from start (m), velocity (m/s), +y up
  let t=0;        // s
  const DT=0.02;

  // World/geometry
  const WORLD_X = 900, WORLD_Y = 560;

  // >>> Increased gap: ceiling way up, floor way down
  const BEAM_Y  = WORLD_Y*0.95;              // top beam y (was 0.82)
  const FLOOR_Y = WORLD_Y*0.05;              // floor y     (was 0.08)

  const PULLEY_X = WORLD_X*0.55;
  const PULLEY_R = 22;

  const BLOCK_W=80, BLOCK_H=60;
  const BLOCK_X = PULLEY_X - PULLEY_R;

  // >>> Block starts in the middle between floor and ceiling
  const START_BLOCK_Y = (FLOOR_Y + BEAM_Y) / 2;

  // VPython objects
  let scene=null, floor=null, beam=null, pulley=null, block=null, person=null, hand=null;
  let ropeLeft=null, ropeTop=null, ropeRight=null;
  let TarrowUp=null, TarrowDown=null, Tlabel=null, Warrow=null, Wlabel=null;

  // For rope length constraint
  let blockTopY0=null, handY0=null;

  // ====== Helpers ======
  function fmt(v, u=''){
    if (!isFinite(v)) return '—';
    const s = Math.abs(v)>=1000 ? v.toFixed(0) : v.toFixed(2);
    return s + (u ? ` ${u}` : '');
  }
  function aNow(){ return (m>0 ? (T/m) - g : 0); }

  // ====== Scene ======
  function initScene(){
    const container = document.getElementById('glowscript');
    container.innerHTML='';
    if (typeof window.__context !== 'undefined') delete window.__context;
    window.__context = { glowscript_container: container };

    if (typeof window.canvas !== 'function') throw new Error('GlowScript not loaded');

    scene = canvas({ width: container.clientWidth||960, height: container.clientHeight||520, background: color.black });
    scene.autoscale=false; scene.userzoom=false; scene.userspin=false;
    scene.center = vec(WORLD_X/2, WORLD_Y/2, 0);
    scene.range  = Math.max(WORLD_X/2, WORLD_Y/2) * 1.06;

    // Floor & top beam
    floor = box({ pos: vec(WORLD_X/2, FLOOR_Y-4, 0), size: vec(WORLD_X, 8, 0.1), color: color.gray(0.4) });
    beam  = box({ pos: vec(WORLD_X/2, BEAM_Y+4, 0), size: vec(WORLD_X*0.9, 8, 0.1), color: color.gray(0.5) });

    // Pulley
    pulley = ring({ pos: vec(PULLEY_X, BEAM_Y - 4, 0), axis: vec(0,0,1), radius: PULLEY_R, thickness: 4, color: color.yellow });

    // Block (start in middle)
    block = box({ pos: vec(BLOCK_X, START_BLOCK_Y, 0), size: vec(BLOCK_W, BLOCK_H, 40), color: color.orange });

    // Person & hand at right
    const px = PULLEY_X + 120;
    person = cylinder({ pos: vec(px, FLOOR_Y, 0), axis: vec(0, 100, 0), radius: 7, color: color.gray(0.8) });
    hand   = sphere({ pos: vec(px, START_BLOCK_Y, 0), radius: 6.5, color: color.cyan });

    // Rope: left vertical, small top over pulley, right vertical
    ropeLeft = curve({ pos:[vec(BLOCK_X, blockTopY(), 0), vec(PULLEY_X - PULLEY_R, pulley.pos.y, 0)],
                       color: color.white, radius: 1.2 });
    ropeTop  = curve({ pos:[vec(PULLEY_X - PULLEY_R, pulley.pos.y, 0), vec(PULLEY_X + PULLEY_R, pulley.pos.y, 0)],
                       color: color.white, radius: 1.2 });
    ropeRight= curve({ pos:[vec(PULLEY_X + PULLEY_R, pulley.pos.y, 0), hand.pos],
                       color: color.white, radius: 1.2 });

    // Force arrows
    TarrowUp   = arrow({ pos: vec(BLOCK_X + BLOCK_W*0.55, block.pos.y + BLOCK_H*0.25, 0), axis: vec(0,0,0), color: color.red,   shaftwidth: 5 });
    Warrow     = arrow({ pos: vec(BLOCK_X - BLOCK_W*0.55, block.pos.y + BLOCK_H*0.25, 0), axis: vec(0,0,0), color: color.cyan, shaftwidth: 5 });
    TarrowDown = arrow({ pos: vec(hand.pos.x + 20, pulley.pos.y - 8, 0), axis: vec(0,0,0), color: color.red,   shaftwidth: 5 });

    Tlabel = label({ pos: vec(hand.pos.x + 70, pulley.pos.y + 16, 0), text: '', color: color.red, height: 14, box:false });
    Wlabel = label({ pos: vec(BLOCK_X - 70, block.pos.y - 10, 0), text: '', color: color.cyan, height: 14, box:false });

    // Set rope constraint reference
    blockTopY0 = blockTopY();
    handY0     = hand.pos.y;

    // Initial sizing
    updateRopeAndForces();
    updateHUD();
  }

  function blockTopY(){ return block.pos.y + BLOCK_H/2; }

  function updateRopeAndForces(){
    // Rope constraint: hand.y = handY0 - (blockTopY - blockTopY0)
    const topL = vec(PULLEY_X - PULLEY_R, pulley.pos.y, 0);
    const topR = vec(PULLEY_X + PULLEY_R, pulley.pos.y, 0);

    const bTopY = blockTopY();
    const dY = (bTopY - blockTopY0);
    hand.pos = vec(hand.pos.x, handY0 - dY, 0);

    // Update rope geometry
    ropeLeft.modify(0, vec(BLOCK_X, bTopY, 0));
    ropeLeft.modify(1, topL);
    ropeTop.modify(0, topL);
    ropeTop.modify(1, topR);
    ropeRight.modify(0, topR);
    ropeRight.modify(1, hand.pos);

    // Force arrows scale
    const sT = Math.min(220, Math.max(0, T) * 0.5);
    const sW = Math.min(220, Math.max(0, m*g) * 0.5);

    TarrowUp.pos  = vec(BLOCK_X + BLOCK_W*0.55, block.pos.y + BLOCK_H*0.05, 0);
    TarrowUp.axis = vec(0, +sT, 0);

    Warrow.pos    = vec(BLOCK_X - BLOCK_W*0.55, block.pos.y + BLOCK_H*0.55, 0);
    Warrow.axis   = vec(0, -sW, 0);

    TarrowDown.pos  = vec(hand.pos.x + 20, pulley.pos.y - 8, 0);
    TarrowDown.axis = vec(0, -sT, 0);

    Tlabel.text = `T = ${T.toFixed(1)} N`;
    Wlabel.text = `mg = ${(m*g).toFixed(1)} N`;
  }

  function updateHUD(){
    aLbl.textContent = fmt(aNow(), 'm/s²');
    vLbl.textContent = fmt(v, 'm/s');
    yLbl.textContent = fmt(y, 'm'); // displacement from start
    tLbl.textContent = fmt(t, 's');
  }

  function clampAtLimits(){
    // Top: block top cannot go above pulley bottom minus small gap
    const topLimit = (pulley.pos.y - PULLEY_R) - (BLOCK_H/2 + 6);
    if (block.pos.y > topLimit){ block.pos.y = topLimit; v = 0; return true; }
    // Bottom: block bottom cannot go below floor
    const bottomLimit = FLOOR_Y + BLOCK_H/2;
    if (block.pos.y < bottomLimit){ block.pos.y = bottomLimit; v = 0; return true; }
    return false;
  }

  // ====== Animation ======
  let animTimer=null;
  function step(){
    if (!block) return;

    const a = aNow();
    v += a * DT;
    y += v * DT;
    block.pos.y = START_BLOCK_Y + y;

    const hit = clampAtLimits();
    updateRopeAndForces();

    t += DT;
    updateHUD();

    if (hit) stop();
  }

  function play(){ stop(); animTimer=setInterval(step, 20); }
  function stop(){ if (animTimer){ clearInterval(animTimer); animTimer=null; } }
  function reset(){
    stop();
    y=0; v=0; t=0;
    if (!block) return;
    block.pos.y = START_BLOCK_Y;
    // reset rope reference
    blockTopY0 = blockTopY();
    handY0     = hand.pos.y;
    updateRopeAndForces();
    updateHUD();
  }

  // ====== Wiring ======
  function sync(slider, input, cb){
    slider.addEventListener('input', e=>{ input.value=e.target.value; cb(parseFloat(e.target.value)); });
    input.addEventListener('input',  e=>{ slider.value=e.target.value; cb(parseFloat(e.target.value)); });
  }

  sync(mS, mI, val=>{ m = Math.max(0.5, Math.min(50, val||0)); updateRopeAndForces(); updateHUD(); });
  sync(TS, TI, val=>{ T = Math.max(0, Math.min(600, val||0));  updateRopeAndForces(); updateHUD(); });
  sync(gS, gI, val=>{ g = Math.max(0, Math.min(20, val||0));   updateRopeAndForces(); updateHUD(); });

  btnPlay.addEventListener('click', play);
  btnPause.addEventListener('click', stop);
  btnReset.addEventListener('click', reset);

  // ====== Robust boot ======
  let tries=0;
  function safeBoot(){
    try{
      if (typeof window.canvas==='function' && typeof window.vec==='function'){
        bootWarn.style.display='none';
        initScene();
        updateHUD();
        return;
      }
    }catch(e){}
    tries++;
    bootWarn.style.display='block';
    if (tries<200) setTimeout(safeBoot, 30);
    else bootWarn.textContent = 'Failed to load GlowScript. Check network/content blocker and reload.';
  }
  window.addEventListener('load', safeBoot);
})();
</script>
</body>
</html>

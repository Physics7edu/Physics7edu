<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Vertical Block–Pulley–Person</title>

  <!-- GlowScript / VPython -->
  <script src="https://www.glowscript.org/lib/jquery/2.1/jquery.min.js"></script>
  <script src="https://www.glowscript.org/lib/jquery/2.1/jquery-ui.custom.min.js"></script>
  <script src="https://www.glowscript.org/package/glow.3.2.min.js"></script>
  <script src="https://www.glowscript.org/package/RSrun.3.2.min.js"></script>

  <style>
    html,body{height:100%;margin:0;background:#0f172a;color:#e5e7eb;font-family:Inter,system-ui,sans-serif}
    .wrap{display:flex;height:100vh}
    .left{width:22rem;padding:1rem;background:#111827;overflow:auto;border-right:1px solid #1f2937}
    .card{background:#1f2937;border-radius:.7rem;padding:.8rem;box-shadow:0 6px 14px rgba(0,0,0,.35);margin-bottom:.8rem}
    .label{font-weight:800;margin:.2rem 0 .4rem}
    .row{display:flex;gap:.6rem;align-items:center}
    .row>*{flex:1}
    input[type=number]{color:#111827;padding:.35rem;border-radius:.4rem}
    .btn{background:#2563eb;color:#fff;border:none;border-radius:.45rem;font-weight:800;padding:.5rem 0}
    .btn:hover{background:#1d4ed8}
    .pair{display:flex;justify-content:space-between;font-weight:800;margin:.18rem 0}
    .pair span:last-child{color:#facc15}
    .right{flex:1;display:flex}
    #glowscript{flex:1}
  </style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <h1 class="text-lg font-extrabold mb-2">Vertical Block–Pulley–Person</h1>

    <div class="card">
      <div class="label">Mass of block m (kg)</div>
      <div class="row">
        <input id="mSlider" type="range" min="0.5" max="50" step="0.5" value="10">
        <input id="mInput"  type="number" min="0.5" max="50" step="0.5" value="10">
      </div>

      <div class="label">Tension T (N)</div>
      <div class="row">
        <input id="TSlider" type="range" min="0" max="600" step="5" value="120">
        <input id="TInput"  type="number" min="0" max="600" step="5" value="120">
      </div>

      <!-- gravity slider REMOVED -->

      <div class="row" style="gap:.5rem;margin-top:.5rem">
        <button id="btnPlay"  class="btn">Play</button>
        <button id="btnPause" class="btn">Pause</button>
        <button id="btnReset" class="btn">Reset</button>
      </div>
      <p id="bootWarn" class="text-sm text-red-300 mt-2" style="display:none">
        Loading 3D engine… If this persists, a network/content blocker may be preventing glowscript.org from loading.
      </p>
    </div>

    <div class="card">
      <div class="pair"><span>Acceleration a</span><span id="aLbl">—</span></div>
      <div class="pair"><span>Velocity v</span><span id="vLbl">—</span></div>
      <div class="pair"><span>Displacement y</span><span id="yLbl">—</span></div>
      <div class="pair"><span>Time t</span><span id="tLbl">—</span></div>
    </div>
  </div>

  <div class="right">
    <div id="glowscript"></div>
  </div>
</div>

<script>
(function(){
  // ====== DOM ======
  const $ = id => document.getElementById(id);
  const mS=$('mSlider'), mI=$('mInput');
  const TS=$('TSlider'), TI=$('TInput');
  const btnPlay=$('btnPlay'), btnPause=$('btnPause'), btnReset=$('btnReset');
  const aLbl=$('aLbl'), vLbl=$('vLbl'), yLbl=$('yLbl'), tLbl=$('tLbl'), bootWarn=$('bootWarn');

  // ====== State ======
  let m=10, T=120, g=9.8;   // g is fixed
  let y=0, v=0, t=0;
  const DT=0.02;

  // World/geometry
  const WORLD_X = 900, WORLD_Y = 560;
  const BEAM_Y  = WORLD_Y*0.95;   // ceiling
  const FLOOR_Y = WORLD_Y*0.05;   // floor

  const PULLEY_X = WORLD_X*0.55;
  const PULLEY_R = 44;            // 200% of original 22

  const BLOCK_W=80, BLOCK_H=60;
  const BLOCK_X = PULLEY_X - PULLEY_R;   // under left rim
  const START_BLOCK_Y = (FLOOR_Y + BEAM_Y) / 2;

  // VPython objects
  let scene=null, floor=null, beam=null, pulley=null, block=null, person=null, hand=null;
  let ropeLeft=null, ropeTop=null, ropeRight=null;
  let TarrowUp=null, TarrowDown=null, Tlabel=null, Warrow=null, Wlabel=null;

  let blockTopY0=null, handY0=null;

  // ====== Helpers ======
  function fmt(v,u=''){ if(!isFinite(v)) return '—'; return v.toFixed(2)+(u?` ${u}`:''); }
  function aNow(){ return (m>0 ? (T/m) - g : 0); }
  function blockTopY(){ return block.pos.y + BLOCK_H/2; }
  function clamp(val,min,max){ return Math.max(min, Math.min(max, val)); }

  function semicirclePoints(cx, cy, r, n=24){
    const pts=[];
    for(let i=0;i<=n;i++){
      const th=Math.PI - (Math.PI*i/n);
      pts.push(vec(cx + r*Math.cos(th), cy + r*Math.sin(th), 0));
    }
    return pts;
  }

  // ====== Scene ======
  function initScene(){
    const container = document.getElementById('glowscript');
    container.innerHTML='';
    if (typeof window.__context !== 'undefined') delete window.__context;
    window.__context = { glowscript_container: container };

    scene = canvas({ width: container.clientWidth||960, height: container.clientHeight||520, background: color.black });
    scene.autoscale=false; scene.userzoom=false; scene.userspin=false;
    scene.center = vec(WORLD_X/2, WORLD_Y/2, 0);
    scene.range  = Math.max(WORLD_X/2, WORLD_Y/2) * 1.06;

    // Floor & top beam
    floor = box({ pos: vec(WORLD_X/2, FLOOR_Y-4, 0), size: vec(WORLD_X, 8, 0.1), color: color.gray(0.4) });
    beam  = box({ pos: vec(WORLD_X/2, BEAM_Y+4, 0), size: vec(WORLD_X*0.9, 8, 0.1), color: color.gray(0.5) });

    pulley = ring({ pos: vec(PULLEY_X, BEAM_Y - 4, 0), axis: vec(0,0,1), radius: PULLEY_R, thickness: 6, color: color.yellow });
    block = box({ pos: vec(BLOCK_X, START_BLOCK_Y, 0), size: vec(BLOCK_W, BLOCK_H, 40), color: color.orange });

    const pullX = PULLEY_X + PULLEY_R;
    person = cylinder({ pos: vec(pullX, FLOOR_Y, 0), axis: vec(0, 100, 0), radius: 7, color: color.gray(0.8) });
    hand   = sphere({ pos: vec(pullX, START_BLOCK_Y, 0), radius: 6.5, color: color.cyan });

    ropeLeft  = curve({ color: color.white, radius: 1.2 });
    ropeTop   = curve({ color: color.white, radius: 1.2 });
    ropeRight = curve({ color: color.white, radius: 1.2 });

    TarrowUp   = arrow({ pos: vec(BLOCK_X + BLOCK_W*0.55, block.pos.y, 0), axis: vec(0,0,0), color: color.red,   shaftwidth: 5 });
    Warrow     = arrow({ pos: vec(BLOCK_X - BLOCK_W*0.55, block.pos.y, 0), axis: vec(0,0,0), color: color.cyan, shaftwidth: 5 });
    TarrowDown = arrow({ pos: vec(pullX + 16, pulley.pos.y - 8, 0), axis: vec(0,0,0), color: color.red,   shaftwidth: 5 });

    Tlabel = label({ pos: vec(pullX + 60, pulley.pos.y + 16, 0), text: '', color: color.red, height: 14, box:false });
    Wlabel = label({ pos: vec(BLOCK_X - 70, block.pos.y - 10, 0), text: '', color: color.cyan, height: 14, box:false });

    blockTopY0 = blockTopY();
    handY0     = hand.pos.y;

    updateRopeAndForces(true);
    updateHUD();
  }

  function updateRopeAndForces(first=false){
    const pullX = PULLEY_X + PULLEY_R;
    const bTopY = blockTopY();
    const dY = (bTopY - blockTopY0);

    const handMin = FLOOR_Y + 10;
    const handMax = BEAM_Y - 10;
    let nextHandY = handY0 - dY;
    nextHandY = clamp(nextHandY, handMin, handMax);
    hand.pos = vec(pullX, nextHandY, 0);

    const topLimit    = (pulley.pos.y - PULLEY_R) - (BLOCK_H/2 + 6);
    const bottomLimit = FLOOR_Y + BLOCK_H/2;
    if (block.pos.y > topLimit)  block.pos.y = topLimit;
    if (block.pos.y < bottomLimit) block.pos.y = bottomLimit;

    const leftContact  = vec(PULLEY_X - PULLEY_R, pulley.pos.y, 0);
    const rightContact = vec(PULLEY_X + PULLEY_R, pulley.pos.y, 0);

    ropeLeft.clear(); ropeLeft.append(vec(BLOCK_X, blockTopY(), 0)); ropeLeft.append(leftContact);

    const pts = semicirclePoints(pulley.pos.x, pulley.pos.y, PULLEY_R, 28);
    ropeTop.clear(); for (const p of pts){ ropeTop.append(p); }

    ropeRight.clear(); ropeRight.append(rightContact); ropeRight.append(hand.pos);

    const sT = Math.min(220, Math.max(0, T) * 0.5);
    const sW = Math.min(220, Math.max(0, m*g) * 0.5);

    TarrowUp.axis  = vec(0, +sT, 0);
    Warrow.axis    = vec(0, -sW, 0);
    TarrowDown.axis = vec(0, -sT, 0);

    Tlabel.text = `T = ${T.toFixed(1)} N`;
    Wlabel.text = `mg = ${(m*g).toFixed(1)} N`;

    if (first){ blockTopY0 = blockTopY(); handY0 = hand.pos.y; }
  }

  function updateHUD(){
    aLbl.textContent = fmt(aNow(), 'm/s²');
    vLbl.textContent = fmt(v, 'm/s');
    yLbl.textContent = fmt(y, 'm');
    tLbl.textContent = fmt(t, 's');
  }

  function clampAtLimits(){
    const topLimit = (pulley.pos.y - PULLEY_R) - (BLOCK_H/2 + 6);
    const bottomLimit = FLOOR_Y + BLOCK_H/2;
    let hit=false;
    if (block.pos.y > topLimit){ block.pos.y = topLimit; v = 0; hit=true; }
    if (block.pos.y < bottomLimit){ block.pos.y = bottomLimit; v = 0; hit=true; }
    return hit;
  }

  // ====== Animation ======
  let animTimer=null;
  function step(){
    const a = aNow();
    v += a * DT;
    y += v * DT;
    block.pos.y = START_BLOCK_Y + y;
    const hit = clampAtLimits();
    updateRopeAndForces();
    t += DT; updateHUD();
    if (hit) stop();
  }

  function play(){ stop(); animTimer=setInterval(step, 20); }
  function stop(){ if (animTimer){ clearInterval(animTimer); animTimer=null; } }
  function reset(){
    stop(); y=0; v=0; t=0;
    block.pos.y = START_BLOCK_Y;
    blockTopY0 = blockTopY(); handY0 = hand.pos.y;
    updateRopeAndForces(true); updateHUD();
  }

  // ====== Wiring ======
  function sync(slider, input, cb){
    slider.addEventListener('input', e=>{ input.value=e.target.value; cb(parseFloat(e.target.value)); });
    input.addEventListener('input',  e=>{ slider.value=e.target.value; cb(parseFloat(e.target.value)); });
  }

  sync(mS, mI, val=>{ m = Math.max(0.5, Math.min(50, val||0)); updateRopeAndForces(); updateHUD(); });
  sync(TS, TI, val=>{ T = Math.max(0, Math.min(600, val||0));  updateRopeAndForces(); updateHUD(); });

  btnPlay.addEventListener('click', play);
  btnPause.addEventListener('click', stop);
  btnReset.addEventListener('click', reset);

  // ====== Boot ======
  let tries=0;
  function safeBoot(){
    try{
      if (typeof window.canvas==='function' && typeof window.vec==='function'){
        bootWarn.style.display='none'; initScene(); return;
      }
    }catch(e){}
    tries++; bootWarn.style.display='block';
    if (tries<200) setTimeout(safeBoot, 30);
    else bootWarn.textContent = 'Failed to load GlowScript. Check network/content blocker and reload.';
  }
  window.addEventListener('load', safeBoot);
})();
</script>
</body>
</html>
